# GCP í´ë¼ìš°ë“œ ì´ê´€ ì™„ë£Œ ë³´ê³ ì„œ

## ðŸ“‹ ê°œìš”

ë¡œì»¬ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ Google Cloud Platform (GCP)ì˜ Cloud SQLë¡œ ì„±ê³µì ìœ¼ë¡œ ì´ê´€í–ˆìŠµë‹ˆë‹¤.

**ì´ê´€ ì¼ì‹œ**: 2025ë…„ 11ì›”  
**ì´ê´€ ë°©ë²•**: Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•œ ì§ì ‘ ë§ˆì´ê·¸ë ˆì´ì…˜  
**ì´ê´€ ë°ì´í„°**: ì´ 106,636ê±´

---

## âœ… ì´ê´€ ì™„ë£Œ ë‚´ì—­

### ë°ì´í„° í†µê³„

| í…Œì´ë¸” | ê±´ìˆ˜ | ìƒíƒœ |
|--------|------|------|
| `proc_stage_mapping` | 5ê±´ | âœ… ì™„ë£Œ |
| `assembly_members` | 306ê±´ | âœ… ì™„ë£Œ |
| `bills` | 7,421ê±´ | âœ… ì™„ë£Œ |
| `votes` | 98,904ê±´ | âœ… ì™„ë£Œ |
| **ì´ê³„** | **106,636ê±´** | **âœ… ì™„ë£Œ** |

### ì†Œìš” ì‹œê°„
- **ì´ ì†Œìš” ì‹œê°„**: ì•½ 28ì´ˆ
- **ì²˜ë¦¬ ì†ë„**: ì•½ 3,800ê±´/ì´ˆ

---

## ðŸš€ ì´ê´€ ê³¼ì •

### 1ë‹¨ê³„: GCP ì¸í”„ë¼ êµ¬ì¶•

#### 1-1. Cloud SQL ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- **ì¸ìŠ¤í„´ìŠ¤ëª…**: `mypoly-postgres`
- **ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„**: PostgreSQL 14
- **ë¨¸ì‹  íƒ€ìž…**: `db-f1-micro` (ë¬´ë£Œ í‹°ì–´)
- **ìŠ¤í† ë¦¬ì§€**: 10GB
- **ë¦¬ì „**: `asia-northeast3` (ì„œìš¸)
- **ê³µê°œ IP**: `34.50.48.31`

#### 1-2. Compute Engine VM ìƒì„±
- **ì¸ìŠ¤í„´ìŠ¤ëª…**: `mypoly-app-server`
- **ë¨¸ì‹  íƒ€ìž…**: `e2-micro` (ë¬´ë£Œ í‹°ì–´)
- **OS**: Ubuntu 22.04 LTS
- **ë¦¬ì „**: `asia-northeast3` (ì„œìš¸)
- **ê³µê°œ IP**: `34.64.212.103`

#### 1-3. ë°©í™”ë²½ ê·œì¹™ ì„¤ì •
- **HTTP íŠ¸ëž˜í”½**: í¬íŠ¸ 80 í—ˆìš©
- **HTTPS íŠ¸ëž˜í”½**: í¬íŠ¸ 443 í—ˆìš©
- **Flask ì•±**: í¬íŠ¸ 5000 í—ˆìš©
- **PostgreSQL**: í¬íŠ¸ 5432 í—ˆìš© (ìŠ¹ì¸ëœ ë„¤íŠ¸ì›Œí¬ë§Œ)

---

### 2ë‹¨ê³„: VM ì´ˆê¸° ì„¤ì •

#### 2-1. í•„ìˆ˜ ì†Œí”„íŠ¸ì›¨ì–´ ì„¤ì¹˜
```bash
# Python, PostgreSQL í´ë¼ì´ì–¸íŠ¸, Git ì„¤ì¹˜
sudo apt-get update
sudo apt-get install -y python3 python3-pip python3-venv postgresql-client git
```

#### 2-2. GitHubì—ì„œ ì½”ë“œ í´ë¡ 
```bash
cd ~
git clone https://github.com/seongyonglim/MyPoly-LawData.git
cd MyPoly-LawData
```

#### 2-3. ê°€ìƒí™˜ê²½ ì„¤ì •
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 2-4. Cloud SQL Proxy ì„¤ì •
```bash
# Cloud SQL Proxy ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰
export CLOUD_SQL_CONNECTION_NAME="fiery-bedrock-479615-u2:asia-northeast3:mypoly-postgres"
./scripts/gcp/start_cloud_sql_proxy.sh
```

#### 2-5. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```bash
# .env íŒŒì¼ ìƒì„±
cat > .env << EOF
DB_HOST=127.0.0.1
DB_NAME=mypoly_lawdata
DB_USER=postgres
DB_PASSWORD=Mypoly!2025
DB_PORT=5432
EOF
```

---

### 3ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„±

#### 3-1. í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ìƒì„±
```bash
# VMì—ì„œ ì‹¤í–‰
cd ~/MyPoly-LawData
psql -h 127.0.0.1 -U postgres -d mypoly_lawdata -f scripts/db/create_tables_postgresql.sql
```

**ìƒì„±ëœ í…Œì´ë¸”**:
- `proc_stage_mapping` (ì§„í–‰ë‹¨ê³„ ë§¤í•‘)
- `assembly_members` (êµ­íšŒì˜ì› ì •ë³´)
- `bills` (ì˜ì•ˆ ì •ë³´)
- `votes` (í‘œê²° ì •ë³´)
- `bill_similarity` (ì˜ì•ˆ ìœ ì‚¬ë„ - ì¶”í›„ ê¸°ëŠ¥ìš©)
- `member_political_profile` (ì˜ì› ì •ì¹˜ í”„ë¡œí•„ - ì¶”í›„ ê¸°ëŠ¥ìš©)
- `user_political_profile` (ì‚¬ìš©ìž ì •ì¹˜ í”„ë¡œí•„ - ì¶”í›„ ê¸°ëŠ¥ìš©)
- `user_votes` (ì‚¬ìš©ìž í‘œê²° ê¸°ë¡ - ì¶”í›„ ê¸°ëŠ¥ìš©)

---

### 4ë‹¨ê³„: ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

#### 4-1. ì‹œë„í•œ ë°©ë²•ë“¤

1. **pg_dump + GCP ì½˜ì†” ê°€ì ¸ì˜¤ê¸°** âŒ
   - ë¬¸ì œ: í™•ìž¥ ê¶Œí•œ ì˜¤ë¥˜, ì†Œìœ ìž ê¶Œí•œ ì˜¤ë¥˜
   - ì›ì¸: Cloud SQLì˜ ì œí•œëœ ê¶Œí•œ

2. **CSV ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°** âŒ
   - ë¬¸ì œ: ì¸ì½”ë”© ì˜¤ë¥˜, ë°ì´í„° íƒ€ìž… ë¶ˆì¼ì¹˜
   - ì›ì¸: Windows/Linux ì¸ì½”ë”© ì°¨ì´

3. **SSH í„°ë„ë§** âŒ
   - ë¬¸ì œ: SSH í‚¤ ì¸ì¦ ì„¤ì • ë³µìž¡
   - ì›ì¸: Windows SSH í‚¤ ì„¤ì • í•„ìš”

4. **VMì—ì„œ ë¡œì»¬ DB ì§ì ‘ ì ‘ì†** âŒ
   - ë¬¸ì œ: ê³µìœ ê¸° í¬íŠ¸ í¬ì›Œë”© í•„ìš”
   - ì›ì¸: NAT í™˜ê²½ì˜ ë³µìž¡ì„±

#### 4-2. ìµœì¢… ì„±ê³µ ë°©ë²•: Cloud SQL ê³µê°œ IP ì§ì ‘ ì‚¬ìš© âœ…

**ë°©ë²•**: ë¡œì»¬ PCì—ì„œ Cloud SQLì˜ ê³µê°œ IPë¡œ ì§ì ‘ ì—°ê²°

**ìž¥ì **:
- âœ… SSH í‚¤ ì„¤ì • ë¶ˆí•„ìš”
- âœ… ê³µìœ ê¸° ì„¤ì • ë¶ˆí•„ìš”
- âœ… GCP ì½˜ì†”ì—ì„œ í´ë¦­ ëª‡ ë²ˆìœ¼ë¡œ ì™„ë£Œ
- âœ… ê°€ìž¥ ê°„ë‹¨í•˜ê³  í™•ì‹¤í•¨

**ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸**: `scripts/gcp/migrate_direct_public_ip.py`

---

### 5ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

#### 5-1. GCP ë°©í™”ë²½ ê·œì¹™ ì¶”ê°€

1. **GCP ì½˜ì†”** â†’ **Cloud SQL** â†’ ì¸ìŠ¤í„´ìŠ¤ `mypoly-postgres` í´ë¦­
2. **"ì—°ê²°"** íƒ­ í´ë¦­
3. **"ìŠ¹ì¸ëœ ë„¤íŠ¸ì›Œí¬"** ì„¹ì…˜ì—ì„œ **"ë„¤íŠ¸ì›Œí¬ ì¶”ê°€"** í´ë¦­
4. ë‹¤ìŒ ì •ë³´ ìž…ë ¥:
   - **ì´ë¦„**: `ë¡œì»¬PC`
   - **ë„¤íŠ¸ì›Œí¬**: `61.74.128.66/32` (ë¡œì»¬ PCì˜ ê³µê°œ IP)
5. **"ì €ìž¥"** í´ë¦­

#### 5-2. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

**ë¡œì»¬ PCì—ì„œ**:
```powershell
cd C:\polywave\MyPoly-LawData
python -m venv .venv
.venv\Scripts\Activate.ps1
pip install psycopg2-binary
python scripts/gcp/migrate_direct_public_ip.py
```

**ì‹¤í–‰ ê²°ê³¼**:
```
[proc_stage_mapping] ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...
  âœ… ì™„ë£Œ: 5ê±´ ì‚½ìž…, 0ê±´ ì˜¤ë¥˜

[assembly_members] ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...
  âœ… ì™„ë£Œ: 306ê±´ ì‚½ìž…, 0ê±´ ì˜¤ë¥˜

[bills] ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...
  âœ… ì™„ë£Œ: 7,421ê±´ ì‚½ìž…, 0ê±´ ì˜¤ë¥˜

[votes] ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...
  âœ… ì™„ë£Œ: 98,904ê±´ ì‚½ìž…, 0ê±´ ì˜¤ë¥˜

ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! (ì†Œìš” ì‹œê°„: 0:00:27.822953)
```

---

### 6ë‹¨ê³„: Flask ì•± ë°°í¬

#### 6-1. VMì—ì„œ ì•± ì‹¤í–‰

```bash
cd ~/MyPoly-LawData
source venv/bin/activate
export $(cat .env | xargs)
python app.py
```

#### 6-2. ì ‘ì† í™•ì¸

- **URL**: `http://34.64.212.103:5000`
- **ìƒíƒœ**: âœ… ì •ìƒ ìž‘ë™

---

## ðŸ“Š ìµœì¢… ì•„í‚¤í…ì²˜

```
ë¡œì»¬ PC (ê°œë°œ í™˜ê²½)
  â†“
GitHub (ì½”ë“œ ì €ìž¥ì†Œ)
  â†“
GCP Compute Engine VM (í”„ë¡œë•ì…˜ ì„œë²„)
  â”œâ”€ Flask ì•± (í¬íŠ¸ 5000)
  â””â”€ Cloud SQL Proxy (í¬íŠ¸ 5432)
      â†“
  GCP Cloud SQL (PostgreSQL)
      â””â”€ ë°ì´í„°ë² ì´ìŠ¤: mypoly_lawdata
```

---

## ðŸ”§ ì‚¬ìš©ëœ ì£¼ìš” ê¸°ìˆ 

- **ì¸í”„ë¼**: Google Cloud Platform (GCP)
- **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL 14 (Cloud SQL)
- **ì„œë²„**: Ubuntu 22.04 LTS (Compute Engine)
- **ì›¹ í”„ë ˆìž„ì›Œí¬**: Flask
- **ë°ì´í„°ë² ì´ìŠ¤ ë“œë¼ì´ë²„**: psycopg2
- **ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬**: Python ìŠ¤í¬ë¦½íŠ¸

---

## ðŸ“ ì£¼ìš” íŒŒì¼

### ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
- `scripts/gcp/migrate_direct_public_ip.py` - ìµœì¢… ì„±ê³µí•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

### VM ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
- `scripts/gcp/setup_vm_complete.sh` - VM ì´ˆê¸° ì„¤ì •
- `scripts/gcp/start_cloud_sql_proxy.sh` - Cloud SQL Proxy ì‹œìž‘
- `scripts/gcp/start_app.sh` - Flask ì•± ì‹œìž‘

### ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
- `scripts/db/create_tables_postgresql.sql` - í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Cloud SQL ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- [x] Compute Engine VM ìƒì„±
- [x] ë°©í™”ë²½ ê·œì¹™ ì„¤ì •
- [x] VM ì´ˆê¸° ì„¤ì • ì™„ë£Œ
- [x] Cloud SQL Proxy ì„¤ì • ì™„ë£Œ
- [x] ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„± ì™„ë£Œ
- [x] ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (106,636ê±´)
- [x] Flask ì•± ë°°í¬ ì™„ë£Œ
- [x] ì›¹ ëŒ€ì‹œë³´ë“œ ì ‘ì† í™•ì¸ ì™„ë£Œ

---

## ðŸŽ¯ í–¥í›„ ê°œì„  ì‚¬í•­

1. **ìžë™ ë°°í¬ íŒŒì´í”„ë¼ì¸**
   - GitHub í‘¸ì‹œ ì‹œ ìžë™ ë°°í¬ (Cloud Build)
   - CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

2. **ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…**
   - Cloud Logging ì—°ë™
   - Cloud Monitoring ì„¤ì •

3. **ë°±ì—… ë° ë³µêµ¬**
   - ìžë™ ë°±ì—… ìŠ¤ì¼€ì¤„ ì„¤ì •
   - ìž¬í•´ ë³µêµ¬ ê³„íš ìˆ˜ë¦½

4. **ë³´ì•ˆ ê°•í™”**
   - SSL/TLS ì¸ì¦ì„œ ì ìš©
   - IAM ì—­í•  ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©

---

## ðŸ“š ì°¸ê³  ë¬¸ì„œ

- [GCP Cloud SQL ì„¤ì • ê°€ì´ë“œ](docs/gcp_cloud_sql_setup_guide.md)
- [VM ë¹ ë¥¸ ì‹œìž‘ ê°€ì´ë“œ](docs/gcp_vm_quick_start.md)
- [ë°©í™”ë²½ ê·œì¹™ ì¶”ê°€ ê°€ì´ë“œ](docs/gcp_add_firewall_rule.md)

---

**ìž‘ì„±ì¼**: 2025ë…„ 11ì›”  
**ìž‘ì„±ìž**: AI Assistant  
**ìƒíƒœ**: âœ… ì™„ë£Œ

