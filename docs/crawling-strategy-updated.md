# 데이터 크롤링 전략 (업데이트)

## 개요

대량 데이터 분석 결과를 바탕으로 각 API의 크롤링 전략을 재검토합니다.

---

## 1. 의안정보 통합 API

### 크롤링 주기

**초기 수집**:
- 22대 국회 전체 의안 수집 (약 5,000~10,000건 예상)
- `start_ord=22`, `end_ord=22` 파라미터 사용
- 페이지네이션으로 전체 수집

**일일 배치 업데이트**:
- 매일 새벽 2시 실행
- 전날 제안된 의안만 수집
- `proposeDt` 기준으로 필터링
- 예: `proposeDt=2025-01-XX` (전날 날짜)

**업데이트 감지**:
- 기존 의안의 `procStageCd` (진행 단계) 변경 감지
- `passGubn` (처리구분) 변경 감지
- `RGS_RSLN_DT` (본회의 의결일) 추가 감지

### 수집 데이터

**확인된 필드 (24개)**:
- `billId` (PK)
- `billName` (의안명)
- `billNo` (의안번호)
- `passGubn` (처리구분)
- `procStageCd` (진행단계)
- `proposeDt` (제안일)
- `proposerKind` (제안자구분)
- `summary` (제안이유 및 주요내용)
- `ERACO` (대수)
- `BILL_KND` (의안종류)
- `PPSR_NM` (제안자명)
- `PPSL_SESS` (제안회기)
- `JRCMIT_NM` (소관위원회명)
- `RGS_CONF_RSLT` (본회의 심의결과)
- `RGS_RSLN_DT` (본회의 의결일)
- `LINK_URL` (상세 링크)
- 기타 필드들...

### 크롤링 스크립트 구조

```python
# scripts/collect_bills.py

def collect_all_bills():
    """전체 의안 수집 (초기)"""
    # 22대 국회 전체 의안 수집
    # 페이지네이션으로 전체 수집
    
def collect_daily_bills(target_date):
    """일일 의안 수집"""
    # 전날 제안된 의안만 수집
    # proposeDt 기준 필터링
    
def update_existing_bills():
    """기존 의안 업데이트"""
    # 진행 단계 변경 감지
    # 처리구분 변경 감지
```

---

## 2. 국회의원 정보 통합 API

### 크롤링 주기

**초기 수집**:
- 22대 국회 전체 의원 정보 수집 (약 300명)
- `pSize=300` 파라미터로 한 번에 수집 가능

**업데이트 주기**:
- **주간 배치** (매주 월요일 새벽 2시)
- 의원 정보는 자주 변경되지 않음
- 변경 가능한 항목:
  - 정당 변경 (`PLPT_NM`)
  - 소속위원회 변경 (`BLNG_CMIT_NM`)
  - 직책 변경 (`DTY_NM`)
  - 연락처 정보 업데이트

**변경 감지**:
- 기존 의원 정보와 비교하여 변경된 필드만 업데이트
- UPSERT 방식 사용

### 수집 데이터

**확인된 필드 (24개)**:
- `NAAS_CD` (PK) - 의원코드
- `NAAS_NM` (의원명)
- `NAAS_CH_NM` (한자명) ⭐ 새로 발견
- `NAAS_EN_NM` (영문명) ⭐ 새로 발견
- `BIRDY_DIV_CD` (생년 구분 코드) ⭐ 새로 발견
- `BIRDY_DT` (생년월일) ⭐ 새로 발견
- `DTY_NM` (직책명) ⭐ 새로 발견
- `PLPT_NM` (정당명)
- `ELECD_NM` (선거구)
- `ELECD_DIV_NM` (선거구 구분명) ⭐ 새로 발견
- `CMIT_NM` (위원회명) ⭐ 새로 발견
- `BLNG_CMIT_NM` (소속위원회명)
- `RLCT_DIV_NM` (선거 구분명 - 초선/재선 등) ⭐ 새로 발견
- `GTELT_ERACO` (당선 대수)
- `NTR_DIV` (성별)
- `NAAS_TEL_NO` (전화번호) - 90.7% NULL
- `NAAS_EMAIL_ADDR` (이메일) - 90.7% NULL
- `NAAS_HP_URL` (홈페이지) - 92.3% NULL
- `AIDE_NM` (보좌관) - 90.7% NULL
- `CHF_SCRT_NM` (선임비서관) - 90.7% NULL
- `SCRT_NM` (비서관) - 90.7% NULL
- `BRF_HST` (약력) ⭐ 새로 발견 - 84.7% NULL
- `OFFM_RNUM_NO` (사무실 호실) - 90.7% NULL
- `NAAS_PIC` (사진 URL)

**데이터 품질**:
- 연락처 정보 (전화번호, 이메일, 홈페이지): 약 10%만 제공
- 보좌관/비서관 정보: 약 10%만 제공
- 약력: 약 15%만 제공

### 크롤링 스크립트 구조

```python
# scripts/collect_members.py

def collect_all_members():
    """전체 의원 정보 수집 (초기)"""
    # 22대 국회 전체 의원 수집
    # pSize=300으로 한 번에 수집
    
def update_members():
    """의원 정보 업데이트 (주간)"""
    # 전체 의원 정보 다시 수집
    # 변경된 필드만 업데이트
    # UPSERT 방식
```

---

## 3. 국회의원 본회의 표결정보 API

### 크롤링 주기

**초기 수집**:
- 처리완료된 의안의 표결 정보 수집
- `passGubn=처리완료` 필터링
- 각 의안별로 표결 정보 수집

**일일 배치 업데이트**:
- 매일 새벽 3시 실행 (의안정보 수집 후)
- 전날 표결된 의안만 수집
- `VOTE_DATE` 기준으로 필터링

**실시간 업데이트 (선택사항)**:
- 본회의 표결이 발생할 때마다 수집
- 웹훅 또는 스케줄러로 구현

### 수집 전략

**의안별 수집**:
1. 의안정보 API에서 처리완료된 의안 ID 목록 조회
2. 각 의안 ID별로 표결정보 API 호출
3. `BILL_ID`와 `AGE=22` 파라미터 사용

**표결 발생 감지**:
- 의안정보 API에서 `procStageCd`가 "본회의"로 변경된 의안 확인
- 해당 의안의 표결 정보 수집

### 수집 데이터

**확인된 필드 (예상)**:
- `BILL_ID` (FK → bills.bill_id)
- `BILL_NO` (의안번호)
- `BILL_NAME` (의안명)
- `AGE` (대수)
- `MEMBER_NO` (FK → assembly_members.member_id)
- `HG_NM` (의원명)
- `POLY_NM` (정당명)
- `RESULT_VOTE_MOD` (표결결과: 찬성/반대/기권/불참)
- `VOTE_DATE` (표결 일시)
- 기타 필드들...

**주의사항**:
- `MEMBER_NO`와 `NAAS_CD`가 동일한지 확인 필요
- 동일하지 않다면 매핑 테이블 필요

### 크롤링 스크립트 구조

```python
# scripts/collect_votes.py

def collect_votes_for_bill(bill_id):
    """특정 의안의 표결 정보 수집"""
    # BILL_ID로 표결 정보 조회
    # AGE=22 파라미터 사용
    
def collect_all_votes():
    """전체 표결 정보 수집 (초기)"""
    # 처리완료된 의안 목록 조회
    # 각 의안별로 표결 정보 수집
    
def collect_daily_votes(target_date):
    """일일 표결 정보 수집"""
    # 전날 표결된 의안만 수집
    # VOTE_DATE 기준 필터링
```

---

## 크롤링 실행 순서

### 초기 수집 (1회)

1. **의원 정보 수집** (약 5분)
   - 전체 의원 정보 수집
   - `assembly_members` 테이블에 저장

2. **의안 정보 수집** (약 30분~1시간)
   - 22대 국회 전체 의안 수집
   - `bills` 테이블에 저장
   - AI 요약 및 카테고리 분류 (후처리)

3. **표결 정보 수집** (약 1~2시간)
   - 처리완료된 의안의 표결 정보 수집
   - `votes` 테이블에 저장

### 일일 배치 (매일 새벽)

1. **의안 정보 수집** (02:00)
   - 전날 제안된 의안 수집
   - 기존 의안 업데이트 (진행 단계 변경 등)

2. **표결 정보 수집** (03:00)
   - 전날 표결된 의안의 표결 정보 수집

3. **AI 요약 처리** (04:00)
   - 신규 의안에 대해 AI 요약 및 카테고리 분류

### 주간 배치 (매주 월요일 새벽)

1. **의원 정보 업데이트** (02:00)
   - 전체 의원 정보 다시 수집
   - 변경된 필드만 업데이트

---

## 데이터 품질 관리

### NULL 데이터 처리

**의원정보 API**:
- 연락처 정보 (전화번호, 이메일, 홈페이지): NULL 허용, "-" 표시
- 보좌관/비서관 정보: NULL 허용, "-" 표시
- 약력: NULL 허용, 표시하지 않음

**의안정보 API**:
- `summary` (제안이유 및 주요내용): AI 요약으로 대체 가능
- 기타 필드: NULL 허용

### 데이터 검증

1. **FK 제약 검증**:
   - 표결 정보 수집 시 `BILL_ID`가 `bills` 테이블에 존재하는지 확인
   - 표결 정보 수집 시 `MEMBER_NO`가 `assembly_members` 테이블에 존재하는지 확인

2. **중복 데이터 처리**:
   - 의안: `bill_id` 기준으로 UPSERT
   - 의원: `member_id` 기준으로 UPSERT
   - 표결: `(bill_id, member_id)` 조합으로 UNIQUE 제약, UPSERT

3. **데이터 타입 검증**:
   - 날짜 형식 검증
   - 숫자 형식 검증
   - JSON 형식 검증 (categories 등)

---

## 성능 최적화

### 배치 처리
- API 호출은 페이지네이션으로 배치 처리
- DB INSERT는 배치 단위로 일괄 처리 (예: 100건씩)

### 캐싱
- 의원 정보는 변경 빈도가 낮으므로 메모리 캐싱
- 의안 정보는 최근 N일치만 캐싱

### 인덱스 활용
- `bill_id`, `member_id` 등 FK 필드에 인덱스 생성
- 조회 성능 최적화를 위한 복합 인덱스 고려

---

## 모니터링

### 수집 현황 추적
- 일일 수집 건수
- 실패 건수 및 원인
- 데이터 업데이트 현황

### 알림
- 수집 실패 시 알림
- 데이터 정합성 오류 시 알림
- API 호출 제한 경고

---

## 요약

| API | 초기 수집 | 일일 배치 | 주간 배치 | 비고 |
|-----|---------|----------|----------|------|
| 의안정보 | ✅ 전체 수집 | ✅ 전날 의안 | - | 진행 단계 변경 감지 |
| 의원정보 | ✅ 전체 수집 | - | ✅ 전체 업데이트 | 변경 빈도 낮음 |
| 표결정보 | ✅ 처리완료 의안 | ✅ 전날 표결 | - | 의안별 수집 |

**총 예상 시간**:
- 초기 수집: 약 2~3시간
- 일일 배치: 약 10~20분
- 주간 배치: 약 5분

