<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„°ë² ì´ìŠ¤ ERD (í…Œì´ë¸” ê´€ê³„ë„)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .erd-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .back-link:hover {
            transform: translateY(-2px);
        }
        
        .header-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #cfd8dc;
        }
        
        .header-section h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .header-section p {
            margin: 0;
            color: #6c757d;
        }
        
        .controls-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        
        .control-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #2196f3;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .diagram-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .diagram-section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }
        
        #mermaid-diagram {
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .legend-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .legend-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-color.core {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        }
        
        .legend-color.user {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        }
        
        .legend-color.mapping {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .table-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .table-info h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .table-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .table-info-item {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .table-info-item strong {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="erd-container">
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/" class="back-link">â† ì˜ì•ˆ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
            <a href="/db-structure" class="back-link" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">ğŸ“‹ í…Œì´ë¸” êµ¬ì¡° ë³´ê¸°</a>
        </div>
        
        <div class="header-section">
            <h1>ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ERD (í…Œì´ë¸” ê´€ê³„ë„)</h1>
            <p>í…Œì´ë¸” ê°„ì˜ ê´€ê³„ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>
        
        <div class="controls-section">
            <div class="control-group">
                <label for="viewMode">í‘œì‹œ ëª¨ë“œ:</label>
                <select id="viewMode">
                    <option value="all">ì „ì²´ í…Œì´ë¸”</option>
                    <option value="core">í•µì‹¬ í…Œì´ë¸”ë§Œ</option>
                    <option value="with_data">ë°ì´í„° ìˆëŠ” í…Œì´ë¸”ë§Œ</option>
                </select>
            </div>
            <div class="control-group">
                <label for="layoutMode">ë ˆì´ì•„ì›ƒ:</label>
                <select id="layoutMode">
                    <option value="LR">ì¢Œìš° (LR)</option>
                    <option value="TB">ìƒí•˜ (TB)</option>
                    <option value="TD">ìœ„ì—ì„œ ì•„ë˜ (TD)</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="refreshDiagram()">ë‹¤ì‹œ ê·¸ë¦¬ê¸°</button>
            <button class="btn btn-secondary" onclick="downloadDiagram()">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        
        <div class="diagram-section">
            <h2>í…Œì´ë¸” ê´€ê³„ë„</h2>
            <div id="mermaid-diagram" class="loading">
                <div>ERDë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...</div>
            </div>
        </div>
        
        <div class="legend-section">
            <h3>ë²”ë¡€</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color core"></div>
                    <span>í•µì‹¬ í…Œì´ë¸” (bills, assembly_members, votes)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color user"></div>
                    <span>ì‚¬ìš©ì ê´€ë ¨ í…Œì´ë¸”</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color mapping"></div>
                    <span>ë§¤í•‘/ì„¤ì • í…Œì´ë¸”</span>
                </div>
            </div>
        </div>
        
        <div class="table-info" id="tableInfo">
            <h3>í…Œì´ë¸” ì •ë³´</h3>
            <div class="table-info-grid" id="tableInfoGrid">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>
    
    <script>
        let mermaidConfig = {
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            er: {
                fontSize: 14,
                layoutDirection: 'LR'
            }
        };
        
        mermaid.initialize(mermaidConfig);
        
        let erdData = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ERD ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadERD() {
            try {
                const response = await fetch('/api/erd');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                erdData = data;
                renderDiagram();
                updateTableInfo(data);
            } catch (error) {
                console.error('ERD ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('mermaid-diagram').innerHTML = 
                    '<div style="color: #e74c3c; text-align: center; padding: 40px;">ERDë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        // ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§
        function renderDiagram() {
            if (!erdData) return;
            
            const viewMode = document.getElementById('viewMode').value;
            const layoutMode = document.getElementById('layoutMode').value;
            
            // í•„í„°ë§
            let tables = erdData.tables;
            if (viewMode === 'core') {
                tables = tables.filter(t => ['bills', 'assembly_members', 'votes'].includes(t.table_name));
            } else if (viewMode === 'with_data') {
                tables = tables.filter(t => t.row_count > 0);
            }
            
            // Mermaid ERD ë¬¸ë²• ìƒì„±
            let mermaidCode = `erDiagram\n`;
            
            // í…Œì´ë¸” ì •ì˜
            tables.forEach(table => {
                const tableType = getTableType(table.table_name);
                mermaidCode += `    ${table.table_name} {\n`;
                
                // ì£¼ìš” ì»¬ëŸ¼ë§Œ í‘œì‹œ (ìµœëŒ€ 10ê°œ, Mermaid ERDëŠ” ì»¬ëŸ¼ì´ ë§ìœ¼ë©´ ë Œë”ë§ì´ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŒ)
                const keyColumns = table.columns.slice(0, 10);
                if (keyColumns.length === 0) {
                    // ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ë¹ˆ ì»¬ëŸ¼ í•˜ë‚˜ë¼ë„ ì¶”ê°€ (Mermaid ERDëŠ” ìµœì†Œ 1ê°œ ì»¬ëŸ¼ í•„ìš”)
                    mermaidCode += `        id\n`;
                } else {
                    keyColumns.forEach(col => {
                        // ì»¬ëŸ¼ ì´ë¦„ì— íŠ¹ìˆ˜ ë¬¸ìê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
                        // ì–¸ë”ìŠ¤ì½”ì–´ë¡œ ì‹œì‘í•˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬
                        let columnName = col.column_name.replace(/[^a-zA-Z0-9_]/g, '_');
                        // ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° ì•ì— ì–¸ë”ìŠ¤ì½”ì–´ ì¶”ê°€
                        if (/^\d/.test(columnName)) {
                            columnName = '_' + columnName;
                        }
                        // ë¹ˆ ë¬¸ìì—´ì´ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                        if (!columnName || columnName.length === 0) {
                            columnName = 'col_' + keyColumns.indexOf(col);
                        }
                        // Mermaid ERDëŠ” ì»¬ëŸ¼ íƒ€ì…ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì»¬ëŸ¼ ì´ë¦„ë§Œ í‘œì‹œ
                        mermaidCode += `        ${columnName}\n`;
                    });
                }
                
                mermaidCode += `    }\n`;
            });
            
            // ê´€ê³„ ì •ì˜
            erdData.relationships.forEach(rel => {
                const fromTable = tables.find(t => t.table_name === rel.from_table);
                const toTable = tables.find(t => t.table_name === rel.to_table);
                
                if (fromTable && toTable) {
                    const cardinality = rel.on_delete === 'CASCADE' ? '||--o{' : '}o--o{';
                    // ê´€ê³„ ë¼ë²¨ì—ì„œ íŠ¹ìˆ˜ ë¬¸ì ì œê±°
                    const label = `${rel.from_column}_to_${rel.to_column}`.replace(/[^a-zA-Z0-9_]/g, '_');
                    mermaidCode += `    ${rel.from_table} ${cardinality} ${rel.to_table} : "${label}"\n`;
                }
            });
            
            // ë ˆì´ì•„ì›ƒ ì„¤ì •
            mermaidConfig.er.layoutDirection = layoutMode;
            mermaid.initialize(mermaidConfig);
            
            // ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§
            const diagramDiv = document.getElementById('mermaid-diagram');
            diagramDiv.innerHTML = '';
            
            mermaid.render('erd-diagram', mermaidCode).then(result => {
                diagramDiv.innerHTML = result.svg;
            }).catch(error => {
                console.error('Mermaid ë Œë”ë§ ì˜¤ë¥˜:', error);
                diagramDiv.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 40px;">ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }
        
        // í…Œì´ë¸” íƒ€ì… íŒë‹¨
        function getTableType(tableName) {
            if (['bills', 'assembly_members', 'votes'].includes(tableName)) {
                return 'core';
            } else if (['user_votes', 'user_political_profile', 'member_political_profile'].includes(tableName)) {
                return 'user';
            } else {
                return 'mapping';
            }
        }
        
        // í…Œì´ë¸” ì •ë³´ ì—…ë°ì´íŠ¸
        function updateTableInfo(data) {
            const grid = document.getElementById('tableInfoGrid');
            grid.innerHTML = '';
            
            data.tables.forEach(table => {
                const item = document.createElement('div');
                item.className = 'table-info-item';
                item.innerHTML = `
                    <strong>${table.table_name}</strong><br>
                    ì»¬ëŸ¼: ${table.columns.length}ê°œ<br>
                    ë°ì´í„°: ${formatNumber(table.row_count)}ê±´<br>
                    ì™¸ë˜í‚¤: ${table.foreign_keys.length}ê°œ
                `;
                grid.appendChild(item);
            });
        }
        
        // ìˆ«ì í¬ë§·íŒ…
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // ë‹¤ì´ì–´ê·¸ë¨ ìƒˆë¡œê³ ì¹¨
        function refreshDiagram() {
            renderDiagram();
        }
        
        // ë‹¤ì´ì–´ê·¸ë¨ ë‹¤ìš´ë¡œë“œ
        function downloadDiagram() {
            const svg = document.querySelector('#mermaid-diagram svg');
            if (!svg) {
                alert('ë‹¤ì´ì–´ê·¸ë¨ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const pngFile = canvas.toDataURL('image/png');
                const downloadLink = document.createElement('a');
                downloadLink.download = 'database-erd.png';
                downloadLink.href = pngFile;
                downloadLink.click();
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('viewMode').addEventListener('change', renderDiagram);
        document.getElementById('layoutMode').addEventListener('change', renderDiagram);
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ERD ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadERD);
    </script>
</body>
</html>

